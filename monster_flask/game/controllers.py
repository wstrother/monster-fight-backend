from monster_flask.game import models
from monster_flask.utils import ModelController


class ColorController(ModelController):
    # color model

    @staticmethod
    def get_color_id(name):
        return models.Color.query.filter_by(name=name).first().id_no

    def add_color(self, name):
        self.add(models.Color(
            name=name
        ))

    # color_mod_value model

    def add_mod_value(self, multiple, ordinal):
        self.add(models.ColorModValue(multiple=multiple, ordinal=ordinal))

    # color_mod model

    def add_mod(self, attacker, target, ordinal):
        self.add(models.ColorMod(
            attacker_id=self.get_color_id(attacker),
            target_id=self.get_color_id(target),
            ordinal=ordinal
        ))

    # API methods

    def get_all(self):
        return [self.get_color_data(c) for c in models.Color.query.all()]

    def get_color_by_id(self, color_id):
        color = models.Color.query.get(color_id)

        if color is None:
            return {"error": "No color found with id {}".format(color_id)}

        return self.get_color_data(color)

    @staticmethod
    def get_color_data(color):
        mods = []
        for m in color.attack_mods:
            mods.append(ColorController.get_color_mod_data(m))

        return {
            "id": color.id_no,
            "name": color.name,
            "mods": mods
        }

    @staticmethod
    def get_color_mod_data(mod):
        return {
            "attacker": mod.attacker_color.name,
            "target": mod.target_color.name,
            "multiple": mod.mod_value.multiple
        }


class StatController(ModelController):
    def add_stat(self, name, default, increment):
        self.add(models.BaseStat(
            name=name, default=default, increment=increment
        ))

    # API methods

    def get_all(self):
        return [self.get_stat_data(s) for s in models.BaseStat.query.all()]

    def get_stat_by_id(self, stat_id):
        stat = models.BaseStat.query.get(stat_id)

        if stat is None:
            return {"error": "No stat found with id {}".format(stat_id)}

        return self.get_stat_data(stat)

    @staticmethod
    def get_stat_data(stat):
        return {
            "name": stat.name,
            "base": stat.default,
            "increment": stat.increment
        }


class SpeciesController(ModelController):
    def add_species(self, name, color_id, life, energy, defense, special):
        self.add(models.Species(
            name=name, color_id=color_id,
            base_life=life, base_energy=energy,
            base_defense=defense, base_special=special
        ))

    # API methods

    def get_all(self):
        return [self.get_species_data(s) for s in models.Species.query.all()]

    def get_species_by_id(self, species_id):
        species = models.Species.query.get(species_id)

        if species is None:
            return {"error": "No species found with id {}".format(species_id)}

        return self.get_species_data(species)

    def get_monster_by_species_id(self, species_id):
        species = models.Species.query.get(species_id)

        if species is None:
            return {"error": "No species found with id {}".format(species_id)}

        stats = models.BaseStat.query.all()
        return self.get_monster_data(species, stats)

    @staticmethod
    def get_species_data(species):
        return {
            "id": species.id_no,
            "name": species.name,
            "color": ColorController.get_color_data(species.color),
            "base_life": species.base_life,
            "base_energy": species.base_energy,
            "base_defense": species.base_defense,
            "base_special": species.base_special
        }

    @staticmethod
    def get_monster_data(species, stats):
        return {
            "species": SpeciesController.get_species_data(species),
            "stats": [StatController.get_stat_data(s) for s in stats]
        }


class MovesController(ModelController):
    # dice_values model

    @staticmethod
    def get_value_id(value):
        return models.DiceValues.query.filter_by(value=value).first().id_no

    def add_dice_value(self, value):
        self.add(models.DiceValues(
            value=value
        ))

    # moves model

    @staticmethod
    def get_move_id(name):
        return models.Move.query.filter_by(name=name).first().id_no

    def add_move(self, name, color_id):
        self.add(models.Move(
            name=name, color_id=color_id
        ))

    # dice model

    def add_die(self, value_id, color_id, move_id):
        self.add(models.Die(
            value_id=value_id, color_id=color_id, move_id=move_id
        ))

    # API methods

    def get_all(self):
        return [self.get_move_data(m) for m in models.Move.query.all()]

    def get_move_by_id(self, move_id):
        move = models.Move.query.get(move_id)

        if move is None:
            return {"error": "No move found with id {}".format(move_id)}

        return self.get_move_data(move)

    def get_moves_by_color(self, color_id):
        return [self.get_move_data(m) for m in models.Move.query.filter_by(color_id=color_id)]

    def get_move_by_color_index(self, color_id, index):
        move = models.Move.query.filter_by(color_id=color_id)[int(index)]

        return self.get_move_data(move)

    @staticmethod
    def get_move_data(move):
        dice = [MovesController.get_die_data(d) for d in move.dice]
        return {
            "name": move.name,
            "color": ColorController.get_color_data(move.move_color),
            "dice": dice,
            "id": move.id_no
        }

    @staticmethod
    def get_die_data(die):
        return {
            "value": die.damage.value,
            "color": ColorController.get_color_data(die.dice_color)
        }
